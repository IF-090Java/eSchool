<!DOCTYPE html>
<html lang="uk">
<style type="text/css">
.error {
    color: red;
}
</style>
<head>
    <meta charset="UTF-8">
    <title>Редагувати клас</title>
    <link rel="stylesheet" type="text/css" href="/css/global-style.css">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="/js/JS.js"></script>
    <script src="/js/jwt-decode.min.js"></script>
</head>
<body>

<div class="wrapper">
    <div class="admin-sidebar"></div>

    <div class="container-fluid" style="padding-left: 0px; padding-right: 0px">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex justify-content-between" style="height: 78px">
            <span class="navbar-text">Ви увійшли як Адміністратор</span>
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="#" onclick="logOut()">Вийти</a>
                </li>
            </ul>
        </nav>

        <div class="container">
            <div id="message" align="center"></div>
            <div class="row justify-content-center mt-5">
                <h1>Редагувати клас</h1>
            </div>
            <div class="row justify-content-center mt-5">
                <div class="col-8">
                    <form id="myForm">
                            <div class="form-group row">
                                <label for="clsName" class="col-3 col-form-label">Назва класу</label>
                                <div class="col-9">
                                    <input class="form-control" id="clsName" type="text" name="className">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="clsYear" class="col-3 col-form-label">Навчальний рік</label>
                                <div class="col-9">
                                    <input class="form-control" id="clsYear" type="text" name="classYear">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="txtArea" class="col-3 col-form-label">Опис класу</label>
                                <div class="col-9">
                                    <textarea id="txtArea" rows="5" name="classDescription" class="form-control"></textarea>
                                </div>
                                <span class="checkmark"></span>
                            </div>

                            <div class="custom-control custom-radio">
                                <input class="custom-control-input" type="radio" name="radioButton" id="exampleRadios1" value="true">
                                <label class="custom-control-label" for="exampleRadios1">Активний</label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input class="custom-control-input" type="radio" name="radioButton" id="exampleRadios2" value="false" checked>
                                <label class="custom-control-label" for="exampleRadios2">Неакивний</label>
                            </div>
                            <div align="center" style="text-align: center; margin: 0 auto;">
                                <button class="btn btn-success" type="submit">Зберегти</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script type="text/javascript">
    $(function() {
        $(".admin-sidebar").load("/views/admin-sidebar.html");
    });
</script>
</body>

<script type="text/javascript">
    $(document).ready(function () {
        validateUserPermissions();
        refreshToken();
        $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " +localStorage.getItem("jwtToken"))
            }
        })
    })

        $(document).ready(function () {

        	jQuery.validator.addMethod("grade", function(value, element) {
                 var inputGrade = value;
				 if (inputGrade.match(/^(?:[5-9]|1[0-1])-([а-г]|[А-Г])$/) || inputGrade.match(/^(?:[5-9]|1[0-1])$/))
					return true;
			     return false;
          }, "Введіть правильну назву класу, наприклад : 10-A або 10 (тільки українські букви)");

          jQuery.validator.addMethod("year", function(value, element) {
                 var year = value;
                 if (year >= 2000)
                    return true;
                 return false;
          }, "Не правильно введений рік");


		  $("#myForm").validate({
            rules: {
                className: {
                    required: true,
                    grade: true
                    },
                classYear: {
                    required: true,
                    minlength: 4,
                    maxlength: 25,
                    year: true
                    }
                },
            messages: {
                className: {
                    required: "Це поле обов'язкове"
                    },
                classYear: {
                    required:  "Це поле обов'язкове",
                    minlength: "Рік повинен містити 4 символи",
                    maxlength: "Рік повинен містити 4 символи"
                    }
                }
            });
        })

    if (window.location.href.indexOf("classes/add")>-1){

        $(document).ready(function () {
            $("title").html("Додавання класу")
            $("h1").html("Додати клас");

            $('form').on('submit', function (e) {
                e.preventDefault();
                var className = $("#clsName").val();
                var classDescription = $("#txtArea").val();
                var classYear = $("#clsYear").val();
                var isActive = document.querySelector("input[name=radioButton]:checked").value;

                $.ajax({
                    type: "post",
                    url: host + "classes",
                    dataType: "json",
                    data: JSON.stringify({
                        "className": className,
                        "classYear": classYear,
                        "classDescription": classDescription,
                        "isActive": isActive
                    }),
                    contentType: "application/json",
                    success: function (responce) {
                        $("#message").attr("class", "alert alert-success");
                        $("#message").html("<strong>Клас створений!</strong>");
                        $(":input").val("");
                    }
                });
            })
        })
    } else {
        $(document).ready(function() {
            var pathArray = window.location.pathname.split('/');
            var classId = pathArray[3];

            $.getJSON(host + 'classes/'+classId, function (data) {
                console.log(data);
                $("#clsName").attr("value", data.className);
                $("#clsYear").attr("value", data.classYear)
                $("#txtArea").append(data.classDescription);
                $(':radio[name=radioButton][value=' + data.isActive + ']').prop('checked', true);
            });
        })

        $(document).ready(function () {
            $('form').on('submit', function (e) {

                e.preventDefault();
                var className = $("#clsName").val();
                var classYear = $("#clsYear").val();
                var classDescription = $("#txtArea").val();
                var isActive = document.querySelector("input[name=radioButton]:checked").value;

                var pathArray = window.location.pathname.split('/');
                var classId = pathArray[3];
                $.ajax({
                    type: "put",
                    url: host + "classes/" + classId,
                    dataType: "json",
                    data: JSON.stringify({
                        "className": className,
                        "classYear": classYear,
                        "classDescription": classDescription,
                        "isActive": isActive
                    }),
                    contentType: "application/json",
                    success: function (responce) {
                        window.location.href = "/ui/classes/list";
                    }
                });
            })
        })
    }
</script>
</body>
</html>