<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Редагування вчителя</title>
    <style type="text/css">
        .error {
            color: red;
        }
        .img-overlay {
            position: absolute;
            top: 0;
            right: 0;
        }
    </style>
    <script src="/js/script.js" type="text/javascript"></script>
    <script src="/js/JS.js"></script>
    <link rel="icon" href="/img/book-icon.png" type="image/x-icon">
	<link rel="shortcut icon" href="/img/book-icon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top justify-content-between" style="background-color: #002c4c !important;"></nav>
<nav class="navbarUser navbar-expand-lg navbar-dark bg-dark" style="height: 110px">
    <a id="homepage" class="ml-5 text-center" style="width: 15%" href="/admin">
        <img id="logo" src="/img/catholic-school-logo.png" width="110" alt="logo"/>
    </a>
    <span id="loggeduser" class="navbar-text ml-5">Ви увійшли як </span>
    <div class="navbar-text float-right mr-4 mt-4 justify-content-center">
            <a class="nav-link" href="#" onclick="logOut()">Вийти</a>
    </div>
</nav>
<div class="row" id="body-row">
    <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2.5"></div>
    <div class="col py-3">

        <div class="row justify-content-center mt-3">
            <h1>Особиcта інформація</h1>
        </div>
        <div class="row mainbox col-md-10 col-lg-8 mt-2 offset-md-1 offset-lg-2 pb-5">
            <div class="container">
                <form action="#" method="PUT" id="myForm">
                    <div class="row form-group required">
                        <label for="fname" class="control-label col-4  requiredField font-weight-bold">Ім'я<span class="asteriskField">*</span></label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="fname" type="text" name="firstname">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="lname" class="control-label col-4  requiredField font-weight-bold">Прізвище<span class="asteriskField">*</span></label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="lname" type="text" name="lastname">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="patronymic" class="control-label col-4  requiredField font-weight-bold" >По-батькові<span class="asteriskField">*</span></label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="patronymic" type="text" name="patronymic" required>
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="username" class="control-label col-4  requiredField font-weight-bold" >Логін<span class="asteriskField">*</span></label>
                        <div class="controls col-8"><input class="input-md textinput textInput form-control" id="username" type="text" name="login"></div>
                    </div>
                    <div class="row form-group required">
                        <label for="dateOfBirth" class="control-label col-4 requiredField font-weight-bold" >Дата народження<span class="asteriskField">*</span></label>
                        <div class="controls col-8">
                            <input class="input-md form-control" id="dateOfBirth" type="date" name="dateOfBirth" >
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="mail" class="control-label col-4" >Електронна адреса:</label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="mail" type="text" name="email">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="mobile" class="control-label col-4">Телефон:</label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="mobile" type="text" name="phone">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="oldPass" class="control-label col-4" >Старий пароль:</label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="oldPass" type="password" name="oldPass form-group">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label for="newPass" class="control-label col-4" >Новий пароль:</label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="newPass" type="password" name="newPass">
                        </div>
                    </div>
                    <div class="row form-group required">
                        <label style="vertical-align: top" for="newPassRepeat" class="control-label col-4" >Повторіть новий пароль:</label>
                        <div class="controls col-8">
                            <input class="input-md textinput textInput form-control" id="newPassRepeat" type="password" name="newPassRepeat">
                            <!-- <p style="font-size: 12px; color: #FF0000" class="registrationFormAlert mt-2" id="divCheckPasswordMatch"></p> -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <img class="img-thumbnail img-fluid rounded float-left" id="avatar" src="/img/profile.png">
                            <div class="img-overlay">
                                <button type="button" id="deletebutton" class="close" aria-label="Close" data-toggle="modal" data-target="#myModal">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="align-self-center col-md-8">
                            <input type="file" class="custom-file-input" id="avatarFile" name="avatar"
                                   accept="image/png, image/jpeg"
                                   onchange="PreviewImage();"
                                   aria-describedby="inputGroupFileAddon01">
                            <label class="custom-file-label" for="avatarFile">Оберіть аватар</label>
                            <br>
                            <p style=" display: inline; font-size: 12px;">* Максимальний розмір - 500 Кб</p>
                        </div>
                    </div>
                    <!-- Modal delete avatar-->
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Видалити фото?</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Ні</button>
                                    <button type="button" id="deleteAvatar" class="btn btn-primary">Так</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Modal deactivate-->
                    <div class="modal fade" id="deactivateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Аккаунт буде деактивовано. Зміни не можливо повернути</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Ні</button>
                                    <button type="button" id="deactivte" class="btn btn-primary">Так</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="warning" class="invisible">
                        <p class="text-center alert alert-danger mb-3 offset-3 col-md-6" id="message"></p>
                    </div>
                    <div align="center" class="mt-3">
                        <button class="btn btn-lg btn-primary" id="submitButton" type="Submit">Зберегти</button>
                        <button class="btn btn-lg btn-danger" id="disableUser" type="button" aria-label="Close" data-toggle="modal" data-target="#deactivateModal">Деактивувати</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        if ((window.location.href.indexOf("ui/teachers/") > -1)||(window.location.href.indexOf("ui/students/") > -1)) {
            $("#sidebar-container").load("/views/admin-sidebar.html");
             $(".navbar").load("/views/admin-header.html");
             $(".navbarUser").hide();
        } else {
              $(".navbar").hide();
        }
        refreshToken();
        $.ajaxSetup({
            beforeSend: function (xhr) {
                if (getJwtToken()) {
                    xhr.setRequestHeader("Authorization", localStorage.getItem("jwtToken"))
                }
            }
        })
    })
    $(document).ready(function() {
        var username;
        var email;
        var pathArray = window.location.pathname.split('/');
        var subjectId = pathArray[3];
        var fileBase64;
        var referrer =  document.referrer;
        if(referrer.indexOf("profile")>-1) {
            $("#homepage").attr("href", referrer);
        }
        $("#deletebutton").hide();
        $("#avatarFile").on('change', function () {
            var file = document.getElementById('avatarFile').files[0];
            var promise = getBase64(file);
            promise.then(function(result) {
                console.log(result);
                fileBase64 = result;
            });
        });
        function setData(data){
            if(window.location.href.indexOf("ui/teacher/") > -1  || window.location.href.indexOf("ui/student/") > -1){
                $("#loggeduser").append(data.login);
            } else {
                $("#loggeduser").append("Адміністратор");
            }
            $("#fname").attr("value", data.firstname);
            $("#lname").attr("value", data.lastname);
            $("#username").attr("value", data.login);
            $("#dateOfBirth").val(data.dateOfBirth);
            $('#patronymic').val(data.patronymic);
            $('#selectClass').val(data.classe);
            $("#mail").attr("value", data.email);
            $("#mobile").attr("value", data.phone);
            if(data.avatar !== null) {
                if (data.avatar.length > 0) {
                    $("#avatar").attr("src", data.avatar);
                    $("#deletebutton").show();
                }
            }
        }
        if ((window.location.href.indexOf("ui/teacher/") > -1)||(window.location.href.indexOf("ui/student/") > -1)) {
            $("#fname").prop('disabled',true);
            $("#lname").prop('disabled',true);
            $("#patronymic").prop('disabled',true);
            $("#username").prop('disabled',true);
            $("#disableUser").hide();
        }
        if ((window.location.href.indexOf("ui/teachers/") > -1)||(window.location.href.indexOf("ui/students/") > -1)) {
            $("#oldPass").prop('disabled',true);
        }
        var endpoint;
        if (window.location.href.indexOf("ui/teacher") > -1) {
            if (window.location.href.indexOf("ui/teachers") > -1)
                endpoint = 'admin/teachers';
            else endpoint = 'teachers'
        }
        else{
            document.title = 'Редагування учня';
            if (window.location.href.indexOf("ui/students") > -1)
                endpoint = 'admin/students';
            else endpoint = 'students';
        }
        $("#deleteAvatar").click(function(){
            fileBase64 = null;
            $("#avatar").attr("src" , "/img/profile.png");
            $(".modal").modal('hide');
            $("#deletebutton").hide();
        });
        $("#deactivte").click(function(){
            $.ajax({
                type: "PATCH",
                url: host + "users/" + subjectId,
                success: function(){
                    window.history.back();
                },
                dataType: "json",
                contentType : "application/json"
            })
            window.history.back();
        });
        jQuery.validator.addMethod("cyrrilic", function(value, element) {
            return this.optional(element) || /^([А-ЯІЇЄҐ][а-яіїєґ']+[-]?)+$/.test(value);
        }, "Ім'я не корректне");
        jQuery.validator.addMethod('filesize', function (value, element, param) {
            return this.optional(element) || (element.files[0].size <= param)
        }, 'Розмір файлу повинен бути менше {0} Байт');
        jQuery.validator.addMethod("dateOfB", function(value, element) {
            var date = new Date(value);
            var today = new Date();
            if (date < today)
                return true;
            return false;
        }, "Дата народження повинна бути в минулому");
        jQuery.validator.addMethod("uniqueEmail", function(value, element) {
            var status;
            $.ajax({
                type: "HEAD",
                async: false,
                url: host + "users/email/" + value + "/",
            }).done(function(message,text,jqXHR){
                status = jqXHR.status;

            }).fail(function (jqXHR) {
                status = jqXHR.status;
            });
            if (status == 200 && $("#mail").val()!=email)
                return false;
            else
                return true;
        }, "Користувач з таким електронним адресом уже існує");
        jQuery.validator.addMethod("uniqueLogin", function(value, element) {
            var status;
            $.ajax({
                type: "HEAD",
                async: false,
                url: host + "users/login/" + value + "/",
            }).done(function(message,text,jqXHR){
                status = jqXHR.status;

            }).fail(function (jqXHR) {
                status = jqXHR.status;
            });
            if (status == 200 && $("#username").val()!=username)
                return false;
            else
                return true;
        }, "Користувач з таким логіном уже існує");
        $("#myForm").validate({
            rules:{
                firstname:{
                    required: true,
                    minlength: 3,
                    maxlength: 25,
                    cyrrilic: true
                },
                lastname:{
                    required: true,
                    minlength: 3,
                    maxlength: 25,
                    cyrrilic: true
                },
                patronymic:{
                    required: true,
                    minlength: 3,
                    maxlength: 25,
                    cyrrilic: true
                },
                login:{
                    required: true,
                    uniqueLogin: true,
                    minlength: 5,
                    maxlength: 40
                },
                email:{
                    email: true,
                    uniqueEmail: true
                },
                newPassRepeat:{
                    equalTo: "#newPass"
                },
                avatar:{
                    filesize: 500000
                },
                dateOfBirth:{
                    dateOfB: true
                }
            },
            messages:{
                firstname:{
                    required: "Це поле обов'язкове",
                    minlength: 'Мінімальна довжина - 3 символи',
                    maxlength: 'Максимальна довжина - 25 символів'
                },
                lastname:{
                    required: "Це поле обов'язкове",
                    minlength: 'Мінімальна довжина - 3 символи',
                    maxlength: 'Максимальна довжина - 25 символів'
                },
                patronymic:{
                    required: "Це поле обов'язкове",
                    minlength: 'Мінімальна довжина - 3 символи',
                    maxlength: 'Максимальна довжина - 25 символів'
                },
                login:{
                    required: "Це поле обов'язкове",
                    uniqueLogin: "Логін не унікальній",
                    minlength: 'Мінімальна довжина - 5 символів',
                    maxlength: 'Максимальна довжина - 40 символів'
                },
                email:{
                    email: "Введіть коректний email",
                    uniqueEmail: "Користувач з таким електронним адресом уже існує"
                },
                newPassRepeat:{
                    equalTo: "Паролі не співпадають"
                },
                avatar:{
                    filesize: "Перевищено максимальний розмір"
                }
            },
            submitHandler: function(form) {
                if (window.location.href.indexOf("ui/teacher") > -1) {
                    var obj = {
                        firstname : $("#fname").val() , lastname: $("#lname").val(),
                        patronymic: $("#patronymic").val(), dateOfBirth: $("#dateOfBirth").val(),
                        login: $("#username").val(),oldPass: $("#oldPass").val(), newPass: $("#newPassRepeat").val(),
                        email: $("#mail").val(), phone : $("#mobile").val(), avatar: $("#avatar").attr("src")
                    };
                    if (window.location.href.indexOf("ui/teachers/")> -1) {
                        obj.oldPass = "adminchangedpass"
                    }
                }
                else{
                    var obj = {
                        firstname : $("#fname").val() , lastname: $("#lname").val(),
                        patronymic: $("#patronymic").val(),  dateOfBirth: $("#dateOfBirth").val(),
                        login: $("#username").val(), oldPass: $("#oldPass").val(), newPass: $("#newPassRepeat").val(),
                        email: $("#mail").val(), phone : $("#mobile").val(), avatar: $("#avatar").attr("src")
                    }
                    if (window.location.href.indexOf("ui/students/")> -1) {
                        obj.oldPass = "adminchangedpass"
                    }
                }
                var formData = JSON.stringify(obj);
                $.ajax({
                    type: "PUT",
                    url: host + endpoint + "/" + subjectId,
                    data: formData,
                    success: function(){
                        console.log(formData);
                        window.history.back();
                    },
                    error: function(jqXHR) {
                        if (jqXHR.responseJSON.status.message == 'Bad Credentials'){
                            $("#warning").attr("class", "visible");
                            $("#message").html("<strong>Неправильний пароль</strong>");
                        };
                    },
                    dataType: "json",
                    contentType : "application/json"
                })
                return false;
            }
        });
        if (window.location.href.indexOf("ui/student") > -1) {
            $.getJSON(host + 'students/' + subjectId, function (data) {
                setData(data.data);
            })
                .fail(function (data) {
                    if (new RegExp("4[0-9][0-9]").test(data.status)){
                        window.location.href='/ui/login'
                    }
                }).always(function (data) {
                username = $("#username").val();
                email = $("#mail").val();
            });
        }
        else{
            $.getJSON(host + 'teachers/' + subjectId, function (data) {
                setData(data.data);
            })
                .fail(function (data) {
                    if (new RegExp("4[0-9][0-9]").test(data.status)){
                        window.location.href='/ui/login'
                    }
                }).always(function (data) {
                username = $("#username").val();
                email = $("#mail").val();
            });
        }
    });
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
</body>
</html>